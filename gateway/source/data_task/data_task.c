/**
*********************************************************************************************************
*                                        		gateway
*                                      (c) Copyright 2021-2031
*                                         All Rights Reserved
*
* @File    : 
* @By      : liwei
* @Version : V0.01
* 
*********************************************************************************************************
**/

/*
*********************************************************************************************************
Includes 
*********************************************************************************************************
*/
#include "hc32f46x_clk.h"
#include "data_task.h"
#include "flash_bsp.h"
#include "logic_control_task.h"
#include "user_type.h"
/*
*********************************************************************************************************
Define
*********************************************************************************************************
*/
#define USER_FLASH_LENGTH               (sizeof(system_information_t))

/*
*********************************************************************************************************
Typedef
*********************************************************************************************************
*/

/*
*********************************************************************************************************
Variables
*********************************************************************************************************
*/
/*缓存用户所有数据，一次性写入FLAHS*/
u8 uesr_flash_buff[USER_FLASH_LENGTH];
/* 导入用户数据指针*/
extern u8 *user_system_data_point;
/*
*********************************************************************************************************
Function 
*********************************************************************************************************
*/
void uesr_data_reset(void);
void set_system_data(void);
void write_system_data(void);
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 
*********************************************************************************************************
**/
void flash_data_check(void )
{
	u8 err = 0;
	for(u8 i = 0; i< 10; i++)
	{
		if(i != uesr_flash_buff[ USER_FLASH_LENGTH - 200 + i ])
		{
			err = 1;
			break;
		}		
	}	
	if(err == 1)
	{
		uesr_data_reset();
		set_system_data();
		write_system_data();
	}
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 
*********************************************************************************************************
**/
void user_read_system_data(void )
{
	flash_read_data(0, uesr_flash_buff, USER_FLASH_LENGTH);	
	flash_data_check();
	memcpy(user_system_data_point , uesr_flash_buff,  USER_FLASH_LENGTH);
	
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 
*********************************************************************************************************
**/
void set_system_data(void )
{
	memcpy( uesr_flash_buff,  user_system_data_point , USER_FLASH_LENGTH);
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 
*********************************************************************************************************
**/
void copy_system_data(void )
{
	memcpy(user_system_data_point , uesr_flash_buff,  USER_FLASH_LENGTH);
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 
*********************************************************************************************************
**/
void write_system_data(void)
{
	flash_write_data(0, uesr_flash_buff, USER_FLASH_LENGTH);
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 
*********************************************************************************************************
**/
void write_room_data(u8 *data, u16 length )
{	
	memcpy(&uesr_flash_buff[0] , data,  length);
	write_system_data();
	copy_system_data();
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	:  
*********************************************************************************************************
**/
void read_set_data(u8 *pointer, u16 *length )
{
	pointer = &uesr_flash_buff[sizeof(room_information_t)];
	*length = sizeof(set_information_t);
}				
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 
*********************************************************************************************************
**/
void write_set_data(u8 *data, u16 length )
{
	u16 romm_num = sizeof(room_information_t);
	memcpy(&uesr_flash_buff[romm_num] , data,  length);
	write_system_data();
	copy_system_data();
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 
*********************************************************************************************************
**/
void read_logic_data(u8 *pointer, u16 *length )
{
	pointer = &uesr_flash_buff[sizeof(set_information_t) + sizeof(room_information_t)];
	*length = sizeof(logic_information_t);
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 
*********************************************************************************************************
**/
void write_logic_data(u8 *data, u16 length )
{

	u16 romm_num = sizeof(room_information_t);
	u16 set_num = sizeof(set_information_t);
	
	memcpy(&uesr_flash_buff[romm_num+set_num] , data,  length);
	write_system_data();
	copy_system_data();
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 
*********************************************************************************************************
**/
void read_scene_data(u8 *pointer, u16 *length )
{
	pointer = &uesr_flash_buff[sizeof(set_information_t) + sizeof(room_information_t) + sizeof(logic_information_t)];
	*length = sizeof(scene_information_t);
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	:  
*********************************************************************************************************
**/
void write_scene_data(u8 *data, u16 length )
{
	u16 romm_num = sizeof(room_information_t);
	u16 set_num = sizeof(set_information_t);
	u16 logic_num = sizeof(logic_information_t);
	
	memcpy(&uesr_flash_buff[romm_num+set_num+logic_num] , data,  length);
	write_system_data();
	copy_system_data();
}
/***********************************************END*****************************************************/

