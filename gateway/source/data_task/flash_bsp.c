/**
*********************************************************************************************************
*                                        		gateway
*                                      (c) Copyright 2021-2031
*                                         All Rights Reserved
*
* @File    : 
* @By      : liwei
* @Version : V0.01
* 
*********************************************************************************************************
**/
/*
*********************************************************************************************************
FLASH空间规划：

FLASH总量为256K 一共32扇区
     地址          	扇区        大小      	用途
00000  -- 0cFFF    	7          	56K      	BOOT
0e000  -- 23FFF    	11 			88K         用户固件			
24000  -- 39FFF		11        	88K 		固件缓存
3A000  -- 3BFFF		1			8K			IAP标志位
3C000  -- 3FFFF		2			16K			用户参数
00000  -- 3FFFF     32          256K         

*********************************************************************************************************
*/  


/*
*********************************************************************************************************
Includes 
*********************************************************************************************************
*/
#include "hc32_ddl.h"
#include "data_task.h"
/*
*********************************************************************************************************
Define
*********************************************************************************************************
*/


/*
*********************************************************************************************************
Typedef
*********************************************************************************************************
*/

/*
*********************************************************************************************************
Variables
*********************************************************************************************************
*/


/*
*********************************************************************************************************
Function 
*********************************************************************************************************
*/

/**
*********************************************************************************************************
* @名称	: 
* @描述	: 写入n个 1字节数据
*********************************************************************************************************
**/
void flash_write_data(u32 addr, u8 *buff, u16 length)
{
    uint16_t i = 0u;
    uint32_t u32Addr;
	uint32_t* u32Addr_p =  (uint32_t*)buff;
    /* Unlock EFM. */
    EFM_Unlock();
    /* Enable flash. */
    EFM_FlashCmd(Enable);
    /* Wait flash ready. */
    while(Set != EFM_GetFlagStatus(EFM_FLAG_RDY))
    {
        ;
    }
    /* Erase sector 62. */
    EFM_SectorErase(FLASH_USER_PARAMETERS_ADRR);

    u32Addr = FLASH_USER_PARAMETERS_ADRR+addr;

    for(i = 0u; i < length/4; i++)
    {
        EFM_SingleProgram(u32Addr,u32Addr_p[i]);
        u32Addr += 4u;
    }
    /* Lock EFM. */
    EFM_Lock();
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 读取n个 1字节数据
*********************************************************************************************************
**/
void flash_read(u8 *buff, u16 length)
{
    uint16_t i = 0u;
    uint32_t *u32Addr=(uint32_t*)FLASH_USER_PARAMETERS_ADRR;
	uint32_t* u32Addr_p =  (uint32_t*)buff;

    for(i = 0u; i < length/4; i++)
		u32Addr_p[i] = u32Addr[i];	

}
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 读取n个 1字节数据
*********************************************************************************************************
**/
void flash_read_data(u32 addr, u8 *buff, u16 length)
{
    uint16_t i = 0u;
    uint32_t *u32Addr=(uint32_t*) (FLASH_USER_PARAMETERS_ADRR + addr);
	uint32_t* u32Addr_p =  (uint32_t*)buff;

    for(i = 0u; i < length/4; i++)
		u32Addr_p[i] = u32Addr[i];	

}
/**
*********************************************************************************************************
* @名称	: 
* @描述	:  
*********************************************************************************************************
**/
void flash_write(u32 addr, u8 *buff, u16 length)
{
    uint16_t i = 0u;
    uint32_t u32Addr;
	uint32_t* u32Addr_p =  (uint32_t*)buff;
    /* Unlock EFM. */
    EFM_Unlock();
    /* Enable flash. */
    EFM_FlashCmd(Enable);
    /* Wait flash ready. */
    while(Set != EFM_GetFlagStatus(EFM_FLAG_RDY))
    {
        ;
    }
    u32Addr = addr;

    for(i = 0u; i < length/4; i++)
    {
        EFM_SingleProgram(u32Addr,u32Addr_p[i]);
        u32Addr += 4u;
    }
    /* Lock EFM. */
    EFM_Lock();
}
/**
*********************************************************************************************************
* @名称	: 
* @描述	: 读取n个 1字节数据 
*********************************************************************************************************
**/
void flash_erase(u32 addr)
{
    /* Unlock EFM. */
    EFM_Unlock();
    /* Enable flash. */
    EFM_FlashCmd(Enable);
    /* Wait flash ready. */
    while(Set != EFM_GetFlagStatus(EFM_FLAG_RDY))
    {
        ;
    }
    /* Erase sector 62. */
    EFM_SectorErase(addr);
    /* Lock EFM. */
    EFM_Lock();
}
/***********************************************END*****************************************************/

