
/***************************************************0522*******************************************************/
继承V0.1版本DEMO程序，更改软件整体框架，使用订阅发布的代理者框架。
订阅发布代理功能完成--broker.c

/*********************************************0524*************************************************************/
完成代理代码缩减，修改程序BUG，完成推送订阅功能。
修改函数void broker_push_information(u8 release)
使用全局代理信息变量 if( ( strstr((char*)broker_information[i]->subscribe_name  ,(char*)broker_information[release]->release_name ) ) != NULL )

/************************************************0525**********************************************************/
优化单个任务的层级关系
增加broket文件中公共功能，增加了各个模块对broket的依赖关系，因此本项目中必须包含broket文件

/***********************************************0526***********************************************************/
实现W5500  两个SCOKET连接 
#define SOCK_DHCP		    0      //DHCP功能用的端口，W5500有8个，0-7都行
#define SOCK_TCPS	        1      //TCP连接用的端口， W5500有8个，0-7都行
#define SOCKET_DNS          2      //DNS功能用的端口， W5500有8个，0-7都行
#define SOCK_TCP_2	        3      //TCP连接用的端口， W5500有8个，0-7都行
ret=getSn_SR(SOCK_TCP_2); 
ret=getSn_SR(SOCK_TCPS); 
两个SCOKET连接   一个客户端接口远程服务器   一个服务器连接本地客户  功能正常
两个SCOKET连接   一个客户端接口远程服务器   一个客户连接本地服务器  功能正常

/************************************************0527**********************************************************/
确定酒店网关初级功能：
1、两路485，一路处理内部酒店协议，一路处理外部转接协议
2、6路IO输入
3、5路IO输出
4、网口，两个SCOKET,一个客户端接口远程服务器   一个客户连接本地服务器
5、FLASH数据处理

/************************************************0527**********************************************************/
完成发布缓存
完成控制逻辑业务的主要功能
酒店数据转键值
外部协议转键值
干接点转键值
键值执行酒店协议
键值执行外部协议
键值执行输出控制

/************************************************0529**********************************************************/
使用任务状态运行
task_init,
task_run,
优化 代理者 和逻辑控制任务

简化单个模块分层，不用统一每个模块的类型，模块的功能要简洁清晰
输出控制任务 简单 结构化

/************************************************0602**********************************************************/
完成read_subscribe_payload 函数 验证
修改 release_buff_read  /*更改发布名字*/
key_buff[0] = 1;/*标记内部查表指令  不再转发本条指令*/
增加 场景 组合 192~223 键值数据发送
定义系统参数结构体：房间，系统，逻辑，场景数据。

/************************************************0604**********************************************************/
增加数据管理任务  完成数据管理和FLASH分层
完成FLASH 数据 读到 uesr_flash_buff  ，然后使用指令更新到 user_system_data   所有用户数据 约为4K
//W5500收发内存分区，收发缓冲区各自总的空间是16K，（0-7）每个端口的收发缓冲区我们分配 2K
char memsize[2][8] = {{2,2,2,2,2,2,2,2},{2,2,2,2,2,2,2,2}}; 
修改端口3的缓存大小  设置为4K接收和发送缓存
成功接收配置服务器 逻辑配置数据 2485个数据

/************************************************0605**********************************************************/
取消数据管理任务 ，FLASH 操作 和数据操作  直接耦合到 以太网和逻辑控制任务中
启动后数据读取在逻辑控制任务中
以太网接收数据正常。FLASH写系统数据正常,读系统数据正常。 用户系统数据系统数据与FLASH映射关系正常
逻辑控制任务中使用 用户系统数据系统数据
/************************************************0605-2**********************************************************/
优化以太网任务结构
恢复DHCP中DHCP_run函数
	dhcp_state = STATE_DHCP_REQUEST;
} else ret = check_DHCP_timeout();
增加 以太网操作C文件  优化以太网代码结构 
实现两个SCOKET数据发送 接收
/************************************************0605-3**********************************************************/
整理以太网任务 结构

/************************************************ 0607 **********************************************************/
改变程序构架风格 ，代码结构要简洁，直观，曲线部分回调函数，将按键和输出合并成一个任务GPIO管理任务
按键引脚必须接地   W5500引脚有一处也要接地
逻辑控制发布指令增加指令指令之间的延时
以太网任务 优化 结构  后期可以增加UDP套接字广播IP
udp接收为阻塞模式   255为广播

/************************************************ 0722 **********************************************************/
取消UDP的SOCKET
修改配置上位机IP地址，改为 复制DHCP 自动获取的 1 2 3 个段地址
场景数据配置 
接收正常 每条场景指令51字节  F1 + 1字节模式号  +2字节组合号 + 5字节灯 +2字节延时 +40字节灯 （51字节）
32组场景数据保存正常
逻辑配置
IO输出配置正常
IO输入配置改为32组，配置正常
内部配置48组数据配置正常 u16  delay 改为u8  delay[2]    由于结构体对齐填充，导致数据长度变化。
外部配置48组数据配置正常

/************************************************ 0723 **********************************************************/
删除UDP的SOCKET代码
推送消息中增加大型数据结构 使用指令类型。（无用）
485任务改为同时管理2个485通讯  增加定时器 提高串口空闲判断速度
修改逻辑控制程序
完成驱动逻辑修改  4种模式 上报
输入逻辑识别4种方式

/************************************************ 0724 **********************************************************/
创建网关用户总信息current_user
数据心跳包上传功能正常， 数据不能有异常FF  导致 灯光不能正常工作
酒店房间信息配置正常，数据正常上报。
逻辑业务直接发送120字节  数据为0  检测异常  release_buff_check   错误使用sizeof(data->release_data.name) 为BUFF长度   灯数据上报正常
增加directional_release_data_to_cache 函数 简化程序结构
/************************************************ 0724-2 **********************************************************/
使用read_subscribe_payload  优化结构

/************************************************ 0728 **********************************************************/
user_total_information_t  包含网关的所有状态  逻辑任务可以使用这个变量  控制所有状态
灯控制逻辑如下：
1、场景和组合执行更新以后,对应的数据在没有其他新的场景组合值的情况下,改字段不变
2、场景属于互斥操作，组合可以实现取反操作，如果组合控制的所有灯熄灭 对应的组合也要置零
3、按键自恢复 和电平有效都是执行一次键值上报。 自恢复（自恢复高和自恢复低一样）无状态属于取反操作，电平有状态绝对操作
4、收的F1 00 00 00 XX 服务键值  网关执行数据更新后  转发F0 xxxxxxxxxxx

current_user 带入计算
按键驱动修改
干接点输入修改
灯   场景 取反 有效模式操作   
组合  取反 有效模式操作 
增加NC 255不操作
增加服务指令 解析 发送
延时加入F1指令发送
key_buff[1] 用于 识别  取反 开   关

/************************************************ 0730 **********************************************************/
NC功能正确
干接点键值触发内部外部转发功能， 判断类型 绝对开关 和自恢复
优化TCP连接失败处理
增加云端10次连接不上，就重启
增加本地服务器IP轮询功能  前三段为自动获取  最后一个IP 依次 为  8 18 28 38 48 58 68 78 88 98 十组IP地址

/************************************************ 0731 **********************************************************/
房间信息结构体优化 改为IP 和NULL
设置信息结构体实名

增加DNS域名解析功能
DNS域名解析正常,解析流程：
1使用UDP 连接 114.114.114.114   53  端口
2使用dns_makequery 函数转换域名
3使用sendto 向DNS服务器发送域名
4接收数据recvfrom并使用parseMSG 解析域名
注意只能使用UDP模式查询域名

增加网络连接流程： 先DNS解析，然后根据DNS解析情况连接云端网络。 目前只有admin.hotelyun.net域名可以正常使用
增加以太网协议文件，剥离协议处理，减小逻辑文件
完成几个服务解析
注意：云端解析后 485需要下发指令

/************************************************ 0802 **********************************************************/
云端网络接收到的数据 只解析键值，总体信息在酒店协议解析中完成并发送协议数据
RELEASE_BUFF_MAX 最大值判断 导致操作溢出  同时优化SUBSCRIBE_AMOUNT 
云端指令灯光 服务 解析为键值,键值改变时云端立即上报

注意：酒店解析功能需要单独成立一个文件  输入输出控制也需要一个单独文件
域名参数导入控制 负载均衡IP导入控制

/************************************************ 0805 **********************************************************/
增加本地酒店协议文件  剥离 酒店解析功能
增加看门狗  连接网络后30秒内无收到云端数据  自动重启
F2 改 F0
串口解析优先发F1指令
拔卡  插卡  关联 模式1 模式2  
组合模式NC正常（功能异常原因是因为上位机下发数据错误）
键值缓存50条  逻辑发布缓存50条    串口转换表支持多次查找

备注：
服务的互斥逻辑  取卡 全清零   勿扰 清部分
取卡延时

/************************************************ 0807 **********************************************************/
清理注释
增加键值宏定义  
完成云端模式 组指令合 下发控制  反馈正常
将cloud_hotel_agreement  改为  ethernet_hotel_agreement
F3本地配置服务器 调试指针工作正常
服务互斥： 退房清其他所有转态点亮清扫   勿扰清除服务和清扫    退卡清除 服务
增加云端空调指令解析 转发数据  更新状态 （BUG内部串口接收到异常数据）
增加云端窗帘指令解析 转发键值 (更新未状态) 
增加云端音乐指令解析 转发键值 (无法测试 更新未状态) 
增加开门指令  转发键值 更新状态
增加延时键值触发功能
以太网任务采用状态和回调函数 60秒未接受到数据 任务自动重启
在网络连接完成后，才能发送心跳包
拔卡延时内 再次插卡 拔卡 延时取消
备注：上报功能测试

/************************************************ 0819 **********************************************************/
移植到新PCB上  更改配置
移植W5500  SPI接口
网络使用了很多常量，后面需要恢复  网络连接不稳定   能连接网络
问题点：
1、FLASH 需要初始化
2、本地设置服务器扫描完一轮后 关闭端口

增加FLASH检测  增加初始化 域名 和平衡IP
以太网复位功能使用切换运行状态，重新复位W5500和初始化
485引脚没有改变
GPIO引脚改变
优化各任务打印信息 和延时时间

/************************************************ 0820 **********************************************************/
打印串口使用DMA发送
注意问题：485有一个串口有异常干扰，需要定位
修改外部晶振宏  
#define XTAL_VALUE ((uint32_t)12000000)  /*!< External high speed OSC freq. */
外部晶振正常工作 


/************************************************ 0821 **********************************************************/
增加DEBUG打印任务，DEBUG打印单独操作发送缓存数据，100ms发送一条，排除数据互斥
外部晶振模式配置异常 导致485 串口无法工作
完成外部时钟配置，系统工作正常
主频200M
stcMpllCfg.pllmDiv = 3u; /* XTAL 12M / 3 */
stcMpllCfg.plln = 100;   /* 4M*100 = 400M */
stcMpllCfg.PllpDiv = 2u; /* MLLP = 200M */
定时器6时钟
stcSysClkCfg.enPclk0Div = ClkSysclkDiv4;
串口时钟
stcSysClkCfg.enPclk1Div = ClkSysclkDiv4;
DEBUG 缓存后 连续数据顺序颠倒
增加IO控制块打印信息，增加IO触发打印信息

/************************************************ 0823 **********************************************************/
完成逻辑 ，系统，场景参数的读取功能
GPIO业务中增加指示灯

/************************************************ 0824 **********************************************************/
以太网操作函数中 有异常导致 外网无法正常工作 恢复0807版本正常工作 (需要定位问题)
云端数据监测功能加入
DEBUG取消任务，使用接口函数
读取UID写入MAC地址
本地服务器  云端服务器都正常连接

/************************************************ 0825 **********************************************************/
增加云端上报选择 云端上报时间  功能正常
增加唯一码
唯一码上报


/************************************************ 0826 **********************************************************/
GPIO输出控制 增加绝对开关控制  
处理门铃 定时恢复控制 使用 瞬时键值和延时反键值共同作用
键值BUFF0 0XF1作为 延时恢复控制标志
key_delay_scanf_handle  改为10MS一次  delay发送改成u32 
将延时自恢复控制，有按键识别自复位键值，产生一个绝对开 和一个延时绝对关的两个键值。 功能完成
逻辑任务中增加定时器 提高延时时间精度  逻辑控制中断回调函数 100ms中断 处理秒级延时  
bsp文件使用  #include "hc32_ddl.h" 
修改lamp_f1_command_package 延时逻辑   继电器延时正常
完成插卡拔卡在逻辑酒店协议中处理延时
完成体感检测，数据发送

问题： 
与逻辑相关的操作 都在 逻辑任务中完成
门磁测试功能  有一个多余数据

/************************************************ 0827 **********************************************************/
门磁测试功测试正常
云端灯控制逻辑反了，修改
485 内外转发延时为MS级别
问题： 逻辑任务发布数据 需要使用并行延时计数

/************************************************ 0827-2 **********************************************************/
业务发布数据  使用并行延时计数
修改release_buff_write  使用发布好判断 功能基本完成
问题：需要测试一下大延时是否会阻塞

/************************************************ 0827-2 **********************************************************/
测试485 内外转发并行正常，大延时正常并执行，不阻塞指令


/************************************************ 0903 **********************************************************/
灯光指令 开状态发100
插卡状态下所有功能正常，拔卡后除了服务类型(服务中又插卡指令  有求救指令)  其他均无效
本地配置服务器 固定使用8   并一直循环重连接。
F3指令测试正常
增加50 51字节协议版本 设置保存功能正常（控制功能未实现）
增加一组灯光亮度参数  场景参数一共33组 设置保存功能正常（控制功能未实现）
UID会出现清零情况  写房间信息的时候，在刷新数据的时候 UID数据会被清零  UID改为一个全局变量数组
场景 组合恢复MS级控制
组合 全部同步操作

/************************************************ 0903 **********************************************************/
增加体感通道 31键值
云端插卡指令不收插卡状态约束
由于F1指令延时固定，单一指令触发F1指令 使用场景1号的延时
门磁功能正常
/************************************************ 0911**********************************************************/
屏蔽TCP设置功能 ，改为接收数据写FLASH

/************************************************ 0912**********************************************************/
TCP数据接收不定长  FLASH写入正确  BOOT手动跳转后用户APP正常执行

/************************************************ 0916**********************************************************/
云端检测逻辑修改	if((ethernet_data_monitor_num > 60000)&&(user_system_data.set.cloud_selection == 1))

/************************************************ 0917**********************************************************/
完成TCP升级功能 （传输中断后可以继续重复升级   升级错误固件后 可以恢复厂家固件）
按照256K规划FLASH
修改控制逻辑：
1、50、51字节灯光指令切换正确
2、最大亮度控制正确正确
3、增加服务指令反馈延时，扩大插卡指令和服务指令的时间差
4、优化酒店键值解析函数 功能分离
5、增加映射控制系统参数
6、增加组合自动同步状态功能（未验证）

/************************************************ 0918**********************************************************/
修改控制逻辑：
1、组合控制 需要判断非0 和0
2、组合自动同步状态功能正确
3、增加设置服务器测试指令

/************************************************ 0922**********************************************************/
IAP策略修改  不区分两个APP区 ，程序在两个APP区都可以直接升级
IAP代码剥离

/************************************************ 0924**********************************************************/
1、完成程序IAP功能 
2、云端发送指令存在连包现象
收到数据：00000008000106000000000800010B00
收到数据：0000000800010A000000000800010900
增加连包解析机制  连包数据必须都为整包数据  
3、增加一个SOK,实现均衡IP获取功能
4、优化升级固件失败后清除标志位,增加延时判断
6、完成空调解析功能，只更新空调数据信息，上传云端


源码开源，删除部分与核心协议相关的代码




